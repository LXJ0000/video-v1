# 视频管理平台后端服务

## 项目简介
该项目是一个基于Go语言和Gin框架开发的视频管理平台后端服务，提供视频文件的基础管理功能，包括上传、获取和管理等功能。项目采用清晰的分层架构，遵循RESTful API设计规范，并实现了统一的错误处理和响应格式。

## 主要功能
### 视频上传
- 视频上传（支持断点续传）
- 支持大文件上传（最大1GB）
- 支持主流视频格式（mp4、mov、avi等）
- 上传时可设置视频标题和描述信息

### 视频获取
- 视频流式播放
- 视频列表查询（支持分页、排序、搜索）
- 视频详情获取

### 视频管理
- 视频管理（列表、详情、修改、删除）
- 支持批量删除
- 支持修改视频基本信息

## 技术栈
- Go 1.20+
- Gin Web框架
- MongoDB数据库
- 文件存储系统

## 项目特点
- 统一的响应格式
- 完善的错误处理
- 规范的代码注释
- 合理的项目分层

## 开发日志

### 2024-01-xx 视频管理功能增强
1. 新增功能
   - 视频状态管理（public/private/draft）
   - 视频标签支持
   - 视频统计信息（观看次数、点赞数等）
   - 批量操作功能
   - 缩略图管理

2. 代码优化
   - 重构视频模型，添加更多元数据
   - 优化文件处理逻辑
   - 增加权限验证
   - 添加更多单元测试

### 2024-02-20 项目初始化
1. 基础功能开发
   - 视频上传和存储
   - 视频列表和详情查询
   - 视频流式播放
   - 基础的增删改查接口

2. 项目结构设计
   - 采用清晰的分层架构（handler/service/model）
   - 统一的错误处理和响应格式
   - 规范的代码注释和文档

### 2024-02-20 功能增强
1. 视频管理功能
   - 视频状态管理（public/private/draft）
   - 视频标签支持
   - 视频统计信息（观看次数、点赞数等）
   - 批量操作功能
   - 缩略图管理

2. 代码优化
   - 重构视频模型，添加更多元数据
   - 优化文件处理逻辑
   - 增加权限验证
   - 添加更多单元测试

### 2024-02-20 问题修复和优化
1. 问题修复
   - 修复视频状态不一致问题（ready -> public）
   - 修复单元测试数据清理问题
   - 完善视频状态管理逻辑
   - 修复查询接口的状态筛选问题

2. 文档完善
   - 更新 API 文档，详细说明视频状态
   - 添加状态转换规则说明
   - 完善接口参数说明
   - 添加错误码说明

3. 工具开发
   - 添加数据库清理脚本，支持多种清理条件
   - 添加视频状态修复脚本
   - 优化测试数据管理，避免污染生产数据

4. 测试改进
   - 改进测试用例，使用测试标记机制
   - 完善测试清理流程
   - 添加更多边界条件测试

5. 经验总结
   - 数据状态管理需要考虑历史数据兼容
   - 测试数据需要有明确的标记和清理机制
   - API 文档需要及时更新并保持一致性
   - 工具脚本可以提高开发和维护效率

### 2024-02-20 性能优化
1. 数据库优化
   - 添加必要的索引（创建时间、状态、标签等）
   - 优化查询条件，避免全表扫描
   - 使用投影查询减少数据传输

2. 文件处理优化
   - 使用流式处理减少内存占用
   - 支持断点续传
   - 异步处理缩略图生成

3. 接口优化
   - 添加缓存支持
   - 优化分页逻辑
   - 减少不必要的数据库查询

### 2024-02-21 功能完善
1. 视频时长功能
   - 添加视频时长字段（duration）
   - 上传时必须提供视频时长
   - 修改相关测试用例
   - 更新 API 文档

2. 测试改进
   - 完善测试数据清理机制
   - 修复测试用例中的数据验证
   - 统一响应格式验证
   - 添加更多边界测试

3. 文档更新
   - 更新 API 文档，添加时长字段说明
   - 完善响应示例
   - 添加字段验证说明
   - 更新开发日志

4. 经验总结
   - 上传接口需要严格的参数验证
   - 测试数据要及时清理
   - 保持文档的同步更新
   - 统一的响应格式很重要

### 待优化项
1. 功能优化
   - 添加视频转码功能
   - 支持更多视频格式
   - 添加视频水印功能
   - 实现视频预览功能

2. 性能优化
   - 实现分布式存储
   - 添加 CDN 支持
   - 优化大文件上传
   - 实现实时统计

3. 运维支持
   - 添加监控指标
   - 完善日志记录
   - 支持容器化部署
   - 添加备份机制

## 项目结构
```
.
├── api/            # API接口定义
├── cmd/            # 主程序入口
│   └── main.go     # 主程序入口文件
├── config/         # 配置文件
│   ├── config.go   # 配置结构定义
│   └── config_test.go # 配置测试文件
├── internal/       # 内部包
│   ├── handler/    # HTTP处理器
│   │   ├── middleware.go # 中间件
│   │   ├── routes.go    # 路由定义
│   │   └── video.go     # 视频处理器
│   ├── model/     # 数据模型
│   │   └── video.go     # 视频模型
│   └── service/   # 业务逻辑
│       ├── video.go     # 视频服务
│       └── video_test.go # 视频服务测试
├── pkg/           # 可重用的包
│   ├── database/  # 数据库相关
│   │   ├── mongodb.go   # MongoDB连接
│   │   └── mongodb_test.go # MongoDB测试
│   └── response/  # 响应处理
│       └── response.go  # 统一响应格式
└── test/          # 测试文件
```

## API文档
### 统一响应格式
```json
{
    "code": 0,      // 0:成功，1:失败
    "msg": "success", // 响应信息
    "data": {}      // 响应数据
}
```

### 视频管理接口

#### 1. 上传视频
- 请求方法: `POST`
- 路径: `/api/v1/videos`
- Content-Type: `multipart/form-data`
- 参数:
  - `file`: 视频文件（必填，支持 mp4/mov/avi/wmv/flv/mkv）
  - `cover`: 封面图文件（可选，支持 jpg/jpeg/png，最大2MB）
  - `title`: 视频标题（必填）
  - `duration`: 视频时长（必填，单位：秒，支持小数点后1位）
  - `description`: 视频描述（可选）
  - `status`: 视频状态（可选，默认为 private）
  - `tags`: 标签（可选，多个标签用逗号分隔）

#### 2. 获取视频列表
- 请求方法: `GET`
- 路径: `/api/v1/videos`
- 参数:
  - `page`: 页码（默认1）
  - `pageSize`: 每页数量（默认10，最大50）
  - `keyword`: 关键词搜索
  - `status`: 视频状态筛选
  - `startDate`: 开始日期（YYYY-MM-DD）
  - `endDate`: 结束日期（YYYY-MM-DD）
  - `tags`: 标签筛选（逗号分隔）
  - `sortBy`: 排序字段
  - `sortOrder`: 排序方向（asc/desc）

#### 3. 获取视频详情
- 请求方法: `GET`
- 路径: `/api/v1/videos/:id`

#### 4. 更新视频信息
- 请求方法: `PUT`
- 路径: `/api/v1/videos/:id`
- Content-Type: `application/json`

#### 5. 删除视频
- 请求方法: `DELETE`
- 路径: `/api/v1/videos/:id`

#### 6. 批量操作视频
- 请求方法: `POST`
- 路径: `/api/v1/videos/batch`
- Content-Type: `application/json`

#### 7. 更新视频缩略图
- 请求方法: `POST`
- 路径: `/api/v1/videos/:id/thumbnail`
- Content-Type: `multipart/form-data`

#### 8. 获取视频统计信息
- 请求方法: `GET`
- 路径: `/api/v1/videos/:id/stats`

#### 9. 视频流式播放
- 请求方法: `GET`
- 路径: `/api/v1/videos/:id/stream`
- 支持范围请求（Range header）

### 视频状态说明
- `public`: 公开，所有人可见
- `private`: 私有，仅作者可见（默认）
- `draft`: 草稿，仅作者可见且不会出现在列表中

### 文件限制
- 视频文件最大 1GB
- 封面图最大 2MB
- 支持的视频格式: mp4, mov, avi, wmv, flv, mkv
- 支持的图片格式: jpg, jpeg, png, gif

### 错误码说明
- 400: 请求参数错误
- 401: 未授权
- 403: 权限不足
- 404: 资源不存在
- 413: 文件太大
- 415: 不支持的文件格式
- 500: 服务器内部错误

## 性能指标
- API平均响应时间 < 200ms
- 支持100用户并发上传
- 支持1000用户并发观看
- 服务可用性 99.9%

## 开发流程
1. 项目初始化
   - 创建基础目录结构
   - 初始化go.mod
   - 配置基础依赖

2. 核心功能开发
   - 配置管理
   - 数据库连接
   - 模型定义
   - 业务逻辑
   - API实现

3. 功能测试
   - 单元测试
   - 接口测试

## 测试说明
### 测试环境准备
```bash
# 安装测试依赖
go get github.com/stretchr/testify/assert

# 确保MongoDB已启动
# 确保配置文件中的MongoDB连接信息正确
```

### 运行测试
```bash
# 运行所有测试
go test ./...

# 运行指定包的测试
go test -v ./config          # 配置模块测试
go test -v ./pkg/database    # 数据库连接测试
go test -v ./internal/service # 服务层测试
go test -v ./internal/handler # 处理器测试

# 生成测试覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
```

### 清理测试数据
```bash
# 清理所有测试数据（包括数据库记录和上传文件）
go run scripts/clean_db.go --test-only

# 试运行模式，只显示要删除的数据，不实际删除
go run scripts/clean_db.go --test-only --dry-run

# 清理指定天数前的数据
go run scripts/clean_db.go --days 30

# 清理所有数据（谨慎使用）
go run scripts/clean_db.go --all

# 帮助信息
go run scripts/clean_db.go --help
```

清理脚本参数说明：
- `--test-only`: 只清理测试数据（以 test_ 开头的用户ID）
- `--days N`: 清理N天前的数据
- `--all`: 清理所有数据
- `--dry-run`: 试运行模式，不实际删除数据

注意事项：
- 建议先使用 `--dry-run` 查看要删除的数据
- 生产环境慎用 `--all` 参数
- 脚本会同时清理数据库记录和上传的文件
- 执行前会要求确认

### 测试用例说明
1. 配置测试 (config_test.go)
   - 测试配置初始化
   - 验证必要配置项
   - 验证上传目录创建

2. 数据库测试 (mongodb_test.go)
   - 测试数据库连接
   - 测试集合获取

3. 视频服务测试 (video_test.go)
   - 测试视频上传
   - 测试视频列表获取
   - 测试视频详情获取
   - 测试视频更新
   - 测试视频删除
   - 测试批量操作
   - 测试缩略图更新
   - 测试统计信息

4. 处理器测试 (handler_test.go)
   - 测试视频上传接口
   - 测试视频列表接口
   - 测试视频详情接口
   - 测试视频流式播放
   - 测试批量操作接口
   - 测试缩略图更新接口
   - 测试统计信息接口

### 注意事项
- 运行测试前确保MongoDB可访问
- 测试会创建临时文件，确保有足够的磁盘空间
- 部分测试可能需要清理测试数据
- 建议在开发环境中运行测试

## 部署说明
1. 环境要求
   - Go 1.20+
   - MongoDB 4.0+
   - 足够的磁盘空间

2. 配置说明
   - MongoDB连接信息
   - 服务器端口
   - 上传文件限制

3. 运行步骤
   ```bash
   # 安装依赖
   go mod download

   # 运行服务
   go run cmd/main.go
   ```

## 注意事项
- 上传目录需要有足够的磁盘空间
- 需要定期清理未使用的视频文件
- 建议使用对象存储服务存储视频文件
- 生产环境建议添加用户认证

## 开发沟通记录

### 2024-02-21 视频时长功能开发
1. 需求分析
   - 需要在视频上传时记录时长信息
   - 时长字段需要支持小数点后1位
   - 时长为必填字段，单位为秒

2. 问题发现与解决
   - 问题：测试用例执行失败
   - 原因：缺少必填的时长字段
   - 解决方案：
     * 修改所有测试用例，添加时长字段
     * 统一响应格式验证
     * 完善测试数据清理机制

3. 代码修改过程
   - 第一轮：基础功能实现
     * 添加 duration 字段到 Video 模型
     * 修改上传接口，接收时长参数
     * 更新 API 文档
   - 第二轮：测试用例修复
     * 更新所有测试用例
     * 添加时长字段验证
     * 统一响应格式
   - 第三轮：文档完善
     * 更新 API 文档
     * 添加字段说明
     * 完善错误码说明

4. 经验总结
   - 添加新字段时需要同步更新：
     * 数据模型
     * API 接口
     * 测试用例
     * 接口文档
   - 保持测试数据的清理
   - 统一的响应格式验证
   - 及时更新文档
